<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAVY AIC Logbook - Shared</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-header { @apply bg-gray-700 text-white font-semibold; }
        .table-cell { @apply p-3 border-b border-gray-600; }
        .card { @apply bg-gray-800 p-6 rounded-lg shadow-xl; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: white; font-size: 1.2rem; text-align: center;
            transition: opacity 0.3s ease-in-out;
        }
        .auth-card {
            max-width: 420px;
            width: 100%;
        }
        .form-tab { @apply px-4 py-2 font-medium text-lg cursor-pointer text-gray-400 border-b-2 border-transparent; }
        .form-tab.active { @apply text-white border-blue-500; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="loading-overlay"><p>Loading Logbook...</p></div>

    <!-- Authentication Container -->
    <div id="auth-container" class="min-h-screen flex flex-col justify-center items-center p-4">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-wider">NAVY AIC LOGBOOK</h1>
            <p class="text-gray-400 mt-2">Team Sign-In</p>
        </header>
        <div class="card auth-card">
            <div class="flex border-b border-gray-700 mb-6">
                <div id="signin-tab" class="form-tab active">Sign In</div>
                <div id="signup-tab" class="form-tab">Sign Up</div>
            </div>

            <!-- Sign In Form -->
            <form id="signin-form">
                <div class="mb-4">
                    <label for="signin-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="signin-email" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2">
                </div>
                <div class="mb-6">
                    <label for="signin-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="signin-password" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">Sign In</button>
            </form>

            <!-- Sign Up Form -->
            <form id="signup-form" class="hidden">
                <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="signup-email" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2">
                </div>
                <div class="mb-6">
                    <label for="signup-password" class="block text-sm font-medium text-gray-300 mb-1">Password (min. 6 characters)</label>
                    <input type="password" id="signup-password" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2">
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition">Create Account</button>
            </form>
             <p id="auth-error" class="text-red-400 text-center mt-4 text-sm"></p>
        </div>
    </div>
    
    <!-- Waiting for Approval Screen -->
    <div id="approval-container" class="hidden min-h-screen flex flex-col justify-center items-center p-4 text-center">
        <h1 class="text-3xl font-bold text-white">Account Pending</h1>
        <p class="text-gray-400 mt-2">Your account has been created. Please wait for the administrator (kiloyankee1004) to grant you access.</p>
        <button id="logout-pending" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Sign Out</button>
    </div>


    <!-- Main App Container -->
    <div id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 flex justify-between items-center">
             <div></div> <!-- Spacer -->
            <div>
                 <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-wider">NAVY AIC LOGBOOK (SHARED)</h1>
                 <p class="text-gray-400 mt-2">Air Intercept Control Record</p>
            </div>
            <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Sign Out</button>
        </header>

        <!-- Admin Panel -->
        <div id="admin-panel" class="hidden card mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Admin Panel: Pending Approvals</h2>
            <div id="approval-list" class="space-y-3">
                <p class="text-gray-400">No new users are waiting for approval.</p>
            </div>
        </div>

        <!-- View Filter -->
        <div class="card mb-8">
            <label for="viewSelect" class="block text-lg font-medium text-gray-300 mb-2">View Logs For</label>
            <select id="viewSelect" class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3"></select>
        </div>

        <!-- Log Entry Form -->
        <div class="card mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">New Log Entry</h2>
            <form id="logForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label for="memberSelect" class="block text-sm font-medium text-gray-300 mb-1">Logging For</label>
                    <select id="memberSelect" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2"></select>
                </div>
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                    <input type="date" id="date" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="time" class="block text-sm font-medium text-gray-300 mb-1">Time (UTC)</label>
                    <input type="time" id="time" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="airspace" class="block text-sm font-medium text-gray-300 mb-1">Name of Airspace</label>
                    <input type="text" id="airspace" placeholder="e.g., W-50B" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="squadron" class="block text-sm font-medium text-gray-300 mb-1">Squadron</label>
                    <input type="text" id="squadron" placeholder="e.g., VFA-101" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="passes" class="block text-sm font-medium text-gray-300 mb-1">Number of Passes</label>
                    <input type="number" id="passes" min="1" placeholder="e.g., 8" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2">
                </div>
                <div class="md:col-span-1">
                    <label for="scale" class="block text-sm font-medium text-gray-300 mb-1">Scale</label>
                    <input type="text" id="scale" placeholder="e.g., 4vs4" required class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2">
                </div>
                <div class="md:col-span-2 lg:col-span-3 text-right mt-4">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">Add Record</button>
                </div>
            </form>
        </div>

        <!-- Logged Records -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Logged Records</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left whitespace-nowrap">
                    <thead>
                        <tr>
                            <th class="table-header table-cell">Member</th>
                            <th class="table-header table-cell">Date</th>
                            <th class="table-header table-cell">Time (UTC)</th>
                            <th class="table-header table-cell">Airspace</th>
                            <th class="table-header table-cell">Squadron</th>
                            <th class="table-header table-cell text-center">Passes</th>
                            <th class="table-header table-cell">Scale</th>
                            <th class="table-header table-cell text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody" class="divide-y divide-gray-700"></tbody>
                </table>
                 <p id="no-records" class="text-center text-gray-400 py-8">No records logged yet.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setDoc, getDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configuration ---
        const memberList = [
            { name: "C.G.Lim", id: "CGLim" }, { name: "H.G.Choi", id: "HGChoi" }, 
            { name: "J.H.Lee", id: "JHLee" }, { name: "E.J.Lee", id: "EJLee" }, 
            { name: "D.K.Son", id: "DKSon" }, { name: "M.C.Kang", id: "MCKang" }, 
            { name: "J.H.Kang", id: "JHKang" }, { name: "H.Y.Lee", id: "HYLee" }, 
            { name: "K.Y.Choi", id: "KYChoi" }, { name: "D.W.Park", id: "DWPark" }, 
            { name: "C.Y.Lee", id: "CYLee" }
        ];

        // =======================================================================
        // TODO: PASTE YOUR ADMIN UID HERE
        // =======================================================================
        const ADMIN_UID = "51jtlIEyF0VaE5fxiuMZXYMlCXu2";
        // =======================================================================

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const approvalContainer = document.getElementById('approval-container');
        const appContainer = document.getElementById('app-container');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const signinTab = document.getElementById('signin-tab');
        const signupTab = document.getElementById('signup-tab');
        const authError = document.getElementById('auth-error');
        const adminPanel = document.getElementById('admin-panel');
        const approvalList = document.getElementById('approval-list');
        const logoutButton = document.getElementById('logout-button');
        const logoutPending = document.getElementById('logout-pending');
        // App elements
        const logForm = document.getElementById('logForm');
        const logTableBody = document.getElementById('logTableBody');
        const noRecordsMessage = document.getElementById('no-records');
        const viewSelect = document.getElementById('viewSelect');
        const memberSelect = document.getElementById('memberSelect');
        
        let db, auth;
        let logsCollectionRef;
        let allRecords = [];
        let unsubscribeLogs; // To stop listening when logged out
        let unsubscribeUsers; // For admin panel

        // --- Auth UI Logic ---
        signinTab.addEventListener('click', () => {
            signinTab.classList.add('active');
            signupTab.classList.remove('active');
            signinForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            authError.textContent = '';
        });
        signupTab.addEventListener('click', () => {
            signupTab.classList.add('active');
            signinTab.classList.remove('active');
            signupForm.classList.remove('hidden');
            signinForm.classList.add('hidden');
            authError.textContent = '';
        });

        // --- Initialization ---
        async function initialize() {
            try {
                // =======================================================================
                // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
                // =======================================================================
                 const firebaseConfig = {
                     apiKey: "AIzaSyBm_g06hcHQlnQA-Rw3MZgpIeX8hV4oJbo",
                     authDomain: "aic-logbook-shared.firebaseapp.com",
                     projectId: "aic-logbook-shared",
                     storageBucket: "aic-logbook-shared.firebasestorage.app",
                     messagingSenderId: "547177573058",
                     appId: "1:547177573058:web:0d8eecf81dbdf9c005695b",
                     measurementId: "G-12MTF7K2VR"
                 };
                // =======================================================================

                if (firebaseConfig.projectId === "YOUR_PROJECT_ID" || !firebaseConfig.projectId) {
                     loadingOverlay.querySelector('p').innerHTML = "Configuration Missing. <br/> Please add your Firebase project config to the HTML file.";
                     return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, handleAuthState);

            } catch (error) {
                console.error("Firebase Init Error:", error);
                loadingOverlay.querySelector('p').textContent = "Could not initialize logbook.";
            }
        }
        
        // --- Main Auth Handler ---
        const handleAuthState = async (user) => {
            if (unsubscribeLogs) unsubscribeLogs();
            if (unsubscribeUsers) unsubscribeUsers();
            
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                // Admin check: The admin bypasses the approval process.
                if (user.uid === ADMIN_UID) {
                    showApp();
                    setupRealtimeLogListener();
                    showAdminPanel();
                    setupAdminListener();
                    
                    // Self-healing: ensure admin user doc is correctly set up
                    if (!userDoc.exists() || !userDoc.data().approved || !userDoc.data().isAdmin) {
                        await setDoc(userDocRef, { email: user.email, approved: true, isAdmin: true }, { merge: true });
                    }
                } else if (userDoc.exists() && userDoc.data().approved) {
                    // Regular, approved user
                    showApp();
                    setupRealtimeLogListener();
                } else {
                    // User is pending approval
                    showApprovalScreen();
                }
            } else {
                // User is signed out
                showAuthScreen();
            }
            loadingOverlay.style.display = 'none';
        };

        // --- View Switching ---
        const showAuthScreen = () => {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            approvalContainer.classList.add('hidden');
        };
        const showApprovalScreen = () => {
            approvalContainer.classList.remove('hidden');
            authContainer.classList.add('hidden');
            appContainer.classList.add('hidden');
        };
        const showApp = () => {
            appContainer.classList.remove('hidden');
            authContainer.classList.add('hidden');
            approvalContainer.classList.add('hidden');
            initializeLogbookUI();
        };
        const showAdminPanel = () => {
            adminPanel.classList.remove('hidden');
        }

        // --- Auth Actions ---
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            authError.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Create a document in the 'users' collection for approval
                await setDoc(doc(db, "users", user.uid), {
                    email: user.email,
                    approved: false,
                    isAdmin: false
                });
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            authError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        const handleSignOut = () => {
            signOut(auth).catch(error => console.error("Sign out error", error));
        };
        logoutButton.addEventListener('click', handleSignOut);
        logoutPending.addEventListener('click', handleSignOut);


        // --- Admin Panel Logic ---
        const setupAdminListener = () => {
            const usersRef = collection(db, "users");
            const q = query(usersRef);
            unsubscribeUsers = onSnapshot(q, (snapshot) => {
                const pendingUsers = [];
                snapshot.forEach(doc => {
                    if (!doc.data().approved) {
                        pendingUsers.push({ id: doc.id, ...doc.data() });
                    }
                });
                renderApprovalList(pendingUsers);
            });
        };

        const renderApprovalList = (users) => {
            approvalList.innerHTML = '';
            if (users.length === 0) {
                approvalList.innerHTML = '<p class="text-gray-400">No new users are waiting for approval.</p>';
                return;
            }
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-700 p-3 rounded';
                div.innerHTML = `
                    <span class="text-gray-300">${user.email}</span>
                    <button data-uid="${user.id}" class="approve-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm">Approve</button>
                `;
                approvalList.appendChild(div);
            });
        };

        approvalList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('approve-btn')) {
                const uidToApprove = e.target.dataset.uid;
                const userDocRef = doc(db, "users", uidToApprove);
                try {
                    await updateDoc(userDocRef, { approved: true });
                } catch (error) {
                    console.error("Error approving user:", error);
                }
            }
        });

        // --- Logbook App Logic ---
        const initializeLogbookUI = () => {
             viewSelect.innerHTML = '';
             memberSelect.innerHTML = '';
             const allOption = document.createElement('option');
             allOption.value = 'all';
             allOption.textContent = 'All Members';
             viewSelect.appendChild(allOption);

             memberList.forEach(member => {
                 const viewOption = document.createElement('option');
                 viewOption.value = member.id;
                 viewOption.textContent = member.name;
                 viewSelect.appendChild(viewOption);

                 const memberOption = document.createElement('option');
                 memberOption.value = member.id;
                 memberOption.textContent = member.name;
                 memberSelect.appendChild(memberOption);
             });
             setDateTime();
        };

        const setDateTime = () => {
            const now = new Date();
            document.getElementById('date').value = now.toISOString().split('T')[0];
            document.getElementById('time').value = now.toISOString().split('T')[1].substring(0, 5);
        };

        const setupRealtimeLogListener = () => {
            logsCollectionRef = collection(db, "aic-logs");
            unsubscribeLogs = onSnapshot(logsCollectionRef, (snapshot) => {
                allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRecords();
            }, (error) => {
                console.error("Error listening to logs: ", error);
            });
        };

        const renderRecords = () => {
            const selectedMemberId = viewSelect.value;
            const filteredRecords = selectedMemberId === 'all'
                ? allRecords
                : allRecords.filter(rec => rec.memberId === selectedMemberId);

            logTableBody.innerHTML = '';
            noRecordsMessage.classList.toggle('hidden', filteredRecords.length > 0);
            logTableBody.classList.toggle('hidden', filteredRecords.length === 0);
            
            filteredRecords.sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));

            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-700/ ৫০', 'transition-colors');
                row.innerHTML = `
                    <td class="table-cell font-medium">${record.memberName}</td>
                    <td class="table-cell">${record.date}</td>
                    <td class="table-cell">${record.time}</td>
                    <td class="table-cell">${record.airspace}</td>
                    <td class="table-cell">${record.squadron}</td>
                    <td class="table-cell text-center">${record.passes}</td>
                    <td class="table-cell">${record.scale}</td>
                    <td class="table-cell text-center">
                        <button onclick="window.deleteRecord('${record.id}')" class="text-red-400 hover:text-red-600 font-semibold transition-colors">Delete</button>
                    </td>
                `;
                logTableBody.appendChild(row);
            });
        };
        
        window.deleteRecord = async (docId) => {
            if (confirm('Are you sure you want to delete this record?')) {
                await deleteDoc(doc(db, "aic-logs", docId));
            }
        };

        viewSelect.addEventListener('change', renderRecords);

        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedMember = memberList.find(m => m.id === memberSelect.value);
            const newRecord = {
                date: document.getElementById('date').value, time: document.getElementById('time').value,
                airspace: document.getElementById('airspace').value, squadron: document.getElementById('squadron').value,
                passes: document.getElementById('passes').value, scale: document.getElementById('scale').value,
                memberId: selectedMember.id, memberName: selectedMember.name
            };
            await addDoc(logsCollectionRef, newRecord);
            logForm.reset();
            setDateTime();
            memberSelect.value = selectedMember.id;
        });

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

